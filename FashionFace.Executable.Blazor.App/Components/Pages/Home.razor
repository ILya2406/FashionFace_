@page "/"
@using FashionFace.Controllers.Requests.Models
@using FashionFace.Executable.Blazor.App.Components.Layout
@using FashionFace.Executable.Blazor.App.Services
@inject AuthorizationService AuthorizationService
@inject NavigationManager Navigation
@layout PublicLayout

<PageTitle>Login - FashionFace</PageTitle>

<link href="css/login.css" rel="stylesheet" />
<div class="login-container">
    <div class="login-card">
        <h3>Welcome Back</h3>
        <p class="text-muted">Sign in to your FashionFace account</p>

        <EditForm Model="@loginModel" OnValidSubmit="@HandleLogin" FormName="login-form">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger">
                    <strong>Login failed:</strong> @errorMessage
                </div>
            }

            <div class="mb-3">
                <label for="username" class="form-label">Username</label>
                <InputText @bind-Value="username"
                           class="form-control"
                           id="username"
                           placeholder="Enter username"
                           autocomplete="username" />
                <ValidationMessage For="@(() => username)" />
            </div>

            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <InputText @bind-Value="password"
                           type="password"
                           class="form-control"
                           id="password"
                           placeholder="Enter password"
                           autocomplete="current-password" />
                <ValidationMessage For="@(() => password)" />
            </div>

            <div class="mb-3 form-check">
                <InputCheckbox @bind-Value="rememberMe" class="form-check-input" id="remember" />
                <label class="form-check-label" for="remember">Remember me</label>
            </div>

            <button type="submit"
                    class="btn btn-primary w-100"
                    disabled="@isLoading">
                @if (isLoading)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                }
                Sign In
            </button>
        </EditForm>
    </div>
</div>

@code {
    public class LoginModel
    {
        public string Username { get; set; } = string.Empty;

        public string Password { get; set; } = string.Empty;
    }

    private LoginModel loginModel = new();
    private string username = "";
    private string password = "";
    private bool rememberMe = false;
    private bool isLoading = false;
    private string? errorMessage;

    private async Task HandleLogin()
    {
        isLoading = true;
        errorMessage = null;

        var loginRequest =
            new LoginRequest(
                username,
                password
            );

        var response =
            await
                AuthorizationService
                    .Login(
                        loginRequest
                    );

        if (response.IsSuccess)
        {
            // Store token if you use JWT (example)
            // await JsRuntime.InvokeVoidAsync("localStorage.setItem", "authToken", response.Token);

            // Redirect to dashboard or main app
            Navigation.NavigateTo("/dashboard"); // or "/" if you want home after login
        }
        else
        {
            errorMessage =
                response
                    .Error!
                    .Error
                    .Code;
        }

        isLoading = false;
    }
}