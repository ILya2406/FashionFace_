@page "/"
@layout PublicLayout

@using FashionFace.Controllers.Requests.Models
@using FashionFace.Executable.Blazor.WebAssembly.Services
@using FashionFace.Executable.Blazor.WebAssembly.Models

@inject AuthorizationService AuthorizationService
@inject NavigationManager NavigationManager

<PageTitle>Login - FashionFace</PageTitle>

<link href="css/login.css" rel="stylesheet" />
<div class="login-container">
    <div class="login-card">
        <h3>Welcome Back</h3>
        <p class="text-muted">Sign in to your FashionFace account</p>

        <EditForm Model="@LoginModel" OnValidSubmit="@HandleLogin" FormName="login-form">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="alert alert-danger">
                    <strong>Login failed:</strong> @ErrorMessage
                </div>
            }

            <div class="mb-3">
                <label for="username" class="form-label">Username</label>
                <InputText @bind-Value="LoginModel.Username"
                           @bind-Value:event="oninput"
                           class="form-control"
                           id="username"
                           placeholder="Enter username"
                           autocomplete="username" />
                <ValidationMessage For="@(() => LoginModel.Username)" />
            </div>

            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <InputText @bind-Value="LoginModel.Password"
                           @bind-Value:event="oninput"
                           type="password"
                           class="form-control"
                           id="password"
                           placeholder="Enter password"
                           autocomplete="current-password" />
                <ValidationMessage For="@(() => LoginModel.Password)" />
            </div>

            <button type="submit"
                    class="btn btn-primary w-100"
                    disabled="@IsLoading">
                @if (IsLoading)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                }
                Sign In
            </button>
        </EditForm>
    </div>
</div>

@code {
    private LoginModel LoginModel  { get; set; } = new();
    private bool IsLoading  { get; set; }
    private string? ErrorMessage  { get; set; }= string.Empty;

    private async Task HandleLogin()
    {
        IsLoading = true;
        ErrorMessage = null;

        var loginRequest =
            new LoginRequest(
                LoginModel.Username,
                LoginModel.Password
            );

        var response =
            await
                AuthorizationService
                    .Login(
                        loginRequest
                    );

        if (response.IsSuccess)
        {
            // Store token if you use JWT (example)
            // await JsRuntime.InvokeVoidAsync("localStorage.setItem", "authToken", response.Token);

            // Redirect to dashboard or main app
            NavigationManager.NavigateTo("/dashboard"); // or "/" if you want home after login
        }
        else
        {
            ErrorMessage =
                response
                    .Error!
                    .Error
                    .Code;
        }

        IsLoading = false;
    }
}